var jq=jQuery.noConflict(),FieldPaletteBackend={registerPlugins:function(){$$("ul.tl_fieldpalette_sortable").each(function(a){FieldPaletteBackend.makeFieldPaletteListSortable(a.id)});jq("table.tl_fieldpalette_wizard").each(function(){FieldPaletteBackend.initDataTable(this)})},initDataTable:function(a){var d=jq("html").attr("lang");var c=false;if(jq(a).hasClass("tl_fieldpalette_sortable")){c={selector:".drag-handle"}}var b;if(jq.fn.dataTable.isDataTable(a)){b=jq(a).DataTable()}else{b=jq(a).DataTable({language:DATATABLE_MESSAGES[d]?DATATABLE_MESSAGES[d]:DATATABLE_MESSAGES.en,stateSave:true,columnDefs:[{searchable:false,orderable:false,targets:0},{targets:"no-sort",orderable:false}],rowReorder:c,pagingType:"full_numbers"})}b.on("row-reorder",function(n,p,q){var g=q.triggerRow.data()["DT_RowId"],o=null;for(var k=0,r=p.length;k<r;k++){if(p[k].node.id==g){o=p[k];break}}if(o===null){return}var m=jq(o.node).find(c.selector),f=m.data("href"),j=m.data("id"),l=m.data("pid");if(o.newPosition==0){f=f.replace(/id=[0-9]*/,"id="+j)+"&act=cut&mode=2&pid="+l;new Request.Contao({url:f,followRedirects:false}).get()}else{var h=jq(a).find("#"+g).prev("tr");if(typeof h=="undefined"){return}l=h.find(c.selector).data("id");f=f.replace(/id=[0-9]*/,"id="+j)+"&act=cut&mode=1&pid="+l;new Request.Contao({url:f,followRedirects:false}).get()}})},deleteFieldPaletteEntry:function(a,b){new Request.Contao({url:a.href,followRedirects:false,onSuccess:function(c,d){FieldPaletteBackend.refreshFieldPalette(a.getParent(".fielpalette-wizard").getProperty("id"))}}).get();return false},makeFieldPaletteListSortable:function(a){var c=new Scroller(document.getElement("body"),{onChange:function(d,e){this.element.scrollTo(this.element.getScroll().x,e)}});var b=new Sortables(a,{constrain:true,opacity:0.6,onStart:function(){c.start()},onComplete:function(){c.stop()},handle:".drag-handle"});b.active=false;b.addEvent("start",function(){b.active=true});b.addEvent("complete",function(f){console.log("COMPLETE");if(!b.active){return}var i,e,g,d;var h=f.getElement(".tl_content_right "+b.options.handle),d=h.get("data-href"),i=h.get("data-id"),e=h.get("data-pid");if(f.getPrevious("li")){e=f.getPrevious("li").getChildren(".tl_content_right "+b.options.handle).get("data-id");d=d.replace(/id=[0-9]*/,"id="+i)+"&act=cut&mode=1&pid="+e;new Request.Contao({url:d,followRedirects:false}).get()}else{if(f.getParent("ul")){d=d.replace(/id=[0-9]*/,"id="+i)+"&act=cut&mode=2&pid="+e;new Request.Contao({url:d,followRedirects:false}).get()}}})},openModalIframe:function(b){var c=b||{};var a=(window.getSize().y-180).toInt();if(!c.height||c.height>a){c.height=a}var d=new SimpleModal({keyEsc:false,width:c.width,hideFooter:true,draggable:false,overlayOpacity:0.5,closeButton:true,onShow:function(){document.body.setStyle("overflow","hidden")},onHide:function(){FieldPaletteBackend.refreshFieldPalette(b.syncId);document.body.setStyle("overflow","auto")}});d.show({title:c.title,contents:'<iframe src="'+c.url+'" width="100%" height="'+c.height+'" frameborder="0" id="fieldPaletteContent"></iframe>'});document.getElementById("fieldPaletteContent").onload=function(){var i=(this.contentDocument.body||this.contentWindow.document.body).getElementById("tl_fieldpalette"),f=(this.contentDocument.body||this.contentWindow.document.body).getElementById("container");if(f!=null){f.classList.add("fieldpalette-form-container")}if(i==null){g=HASTE_PLUS.removeParameterFromUri(g,"closeModal");i.setAttribute("action",g);return false}var e=i.querySelectorAll(".tl_error").length>0;var g=i.getAttribute("action"),h=HASTE_PLUS.getParameterByName("closeModal",g);if(h&&!e){d.hide()}else{g=HASTE_PLUS.removeParameterFromUri(g,"closeModal");i.setAttribute("action",g)}i.getElementById("saveNclose").addEventListener("click",function(){g=HASTE_PLUS.addParameterToUri(g,"closeModal",1);i.setAttribute("action",g)})}},refreshFieldPalette:function(b){var a=b.replace("ctrl_","");console.log(a);new Request.Contao({onRequest:function(){$(b).getElement(".tl_fielpalette_indicator").show()},onSuccess:function(c,e){var d=new Element("div",{html:e.content});d.getFirst().replaces($(b));$(b).getElement(".tl_fielpalette_indicator").hide();FieldPaletteBackend.registerPlugins()}}).post({action:"refreshFieldPaletteField",field:a,REQUEST_TOKEN:Contao.request_token})}};window.addEvent("domready",function(){FieldPaletteBackend.registerPlugins()});